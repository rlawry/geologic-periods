<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phanerozoic Sit-in-the-Period (Three.js)</title>

  <!-- For consistent importmap support on GitHub Pages across browsers -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { position: fixed; inset: 0; }

    #prompt {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(840px, calc(100vw - 32px));
      background: rgba(20, 26, 34, 0.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px 16px;
      line-height: 1.25;
      text-align: center;
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
      user-select: none;
      pointer-events: none;
      font-size: 18px;
    }
    #prompt .small {
      display: block;
      margin-top: 6px;
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }

    #score {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-weight: 800;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: 0.5px;
      text-shadow: 0 6px 20px rgba(0,0,0,0.45);
      user-select: none;
      pointer-events: none;
    }

    #flash {
      position: fixed;
      inset: 0;
      background: transparent;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    #flash.on { opacity: 0.85; }
    #flash.green { background: #00c853; }
    #flash.red { background: #ff1744; }

    .label {
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
      pointer-events: none;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    #hint {
      position: fixed;
      left: 16px;
      bottom: 16px;
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      user-select: none;
      pointer-events: none;
      max-width: 360px;
      line-height: 1.25;
    }
  </style>
</head>

<body>
  <div id="app"></div>
  <div id="flash"></div>

  <div id="prompt">
    <div id="promptMain">Loading…</div>
    <span class="small">Move: ↑ / ↓ &nbsp;•&nbsp; Sit: Space</span>
  </div>

  <div id="score">Score: 0</div>
  <div id="hint">Older end: Cambrian (541 Ma) ← &nbsp;&nbsp;→ Present (0 Ma): Quaternary</div>

  <script type="module">
    import * as THREE from "three";
    import { CSS2DRenderer, CSS2DObject } from "three/addons/renderers/CSS2DRenderer.js";

    // -----------------------
    // Phanerozoic periods (Ma)
    // -----------------------
    const PERIODS = [
      { name: "Cambrian",      start: 541.0,    end: 485.4,   color: 0x2ecc71 },
      { name: "Ordovician",    start: 485.4,    end: 443.8,   color: 0x27ae60 },
      { name: "Silurian",      start: 443.8,    end: 419.2,   color: 0x16a085 },
      { name: "Devonian",      start: 419.2,    end: 358.9,   color: 0x1abc9c },
      { name: "Carboniferous", start: 358.9,    end: 298.9,   color: 0x3498db },
      { name: "Permian",       start: 298.9,    end: 251.902, color: 0x9b59b6 },
      { name: "Triassic",      start: 251.902,  end: 201.36,  color: 0xe67e22 },
      { name: "Jurassic",      start: 201.36,   end: 145.0,   color: 0xf1c40f },
      { name: "Cretaceous",    start: 145.0,    end: 66.0,    color: 0xf39c12 },
      { name: "Paleogene",     start: 66.0,     end: 23.03,   color: 0xe74c3c },
      { name: "Neogene",       start: 23.03,    end: 2.58,    color: 0xc0392b },
      { name: "Quaternary",    start: 2.58,     end: 0.0,     color: 0xecf0f1 }
    ];

    const TOTAL_MA = 541.0;
    const SLAB_LEN = 780;      // along Z
    const SLAB_W = 120;        // along X
    const SLAB_H = 18;         // along Y

    function maToZ(ma) {
      const t = (TOTAL_MA - ma) / TOTAL_MA;
      return (t * SLAB_LEN) - SLAB_LEN / 2;
    }

    const app = document.getElementById("app");
    const promptMain = document.getElementById("promptMain");
    const scoreEl = document.getElementById("score");
    const flashEl = document.getElementById("flash");

    const LOGO_PATHS = {
      Cambrian:      "assets/logos/Cambrian.png",
      Ordovician:    "assets/logos/Ordovician.png",
      Silurian:      "assets/logos/Silurian.png",
      Devonian:      "assets/logos/Devonian.png",
      Carboniferous: "assets/logos/Carboniferous.png",
      Permian:       "assets/logos/Permian.png",
      Triassic:      "assets/logos/Triassic.png",
      Jurassic:      "assets/logos/Jurassic.png",
      Cretaceous:    "assets/logos/Cretaceous.png",
      Paleogene:     "assets/logos/Paleogene.png",
      Neogene:       "assets/logos/Neogene.png",
      Quaternary:    "assets/logos/Quaternary.png"
    };
    
    const texLoader = new THREE.TextureLoader();
    const logoTex = new Map();
    
    function loadLogo(name) {
      if (logoTex.has(name)) return logoTex.get(name);
    
      const url = LOGO_PATHS[name];
      if (!url) return null;
    
      const t = texLoader.load(url);
      t.colorSpace = THREE.SRGBColorSpace;
      t.anisotropy = 8;
      logoTex.set(name, t);
      return t;
    }

    let currentLogoName = null;

    function updateShirtLogo(periodName) {
      if (!periodName || periodName === currentLogoName) return;
      const t = loadLogo(periodName);
      if (t) {
        shirtMat.map = t;
        shirtMat.needsUpdate = true;
        currentLogoName = periodName;
      }
    }

    // -----------------------
    // Scene setup
    // -----------------------
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b0f14, 260, 900);

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2200);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = "fixed";
    labelRenderer.domElement.style.inset = "0";
    labelRenderer.domElement.style.pointerEvents = "none";
    app.appendChild(labelRenderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(150, 200, 80);
    scene.add(dir);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(2200, 2200),
      new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -40;
    scene.add(ground);

    // -----------------------
    // Slab + segments
    // -----------------------
    const slabGroup = new THREE.Group();
    scene.add(slabGroup);

    const baseSlab = new THREE.Mesh(
      new THREE.BoxGeometry(SLAB_W, SLAB_H, SLAB_LEN),
      new THREE.MeshStandardMaterial({ color: 0x232a33, roughness: 0.85, metalness: 0.05 })
    );
    slabGroup.add(baseSlab);

    const topY = SLAB_H / 2 + 0.6;
    const segH = 1.2;

    // Store meshes/materials so we can "glow" the one the player is over
    const periodSegments = [];

    for (const p of PERIODS) {
      const zA = maToZ(p.start);
      const zB = maToZ(p.end);
      const zMin = Math.min(zA, zB);
      const zMax = Math.max(zA, zB);
      const segLen = Math.max(1, zMax - zMin);
      const zCenter = (zMin + zMax) / 2;

      // emissive-based glow (fast, no postprocessing needed)
      const segMat = new THREE.MeshStandardMaterial({
        color: p.color,
        roughness: 0.65,
        metalness: 0.05,
        emissive: new THREE.Color(p.color),
        emissiveIntensity: 0.0
      });

      const seg = new THREE.Mesh(
        new THREE.BoxGeometry(SLAB_W + 0.6, segH, segLen),
        segMat
      );
      seg.position.set(0, topY, zCenter);
      slabGroup.add(seg);

      const divider = new THREE.Mesh(
        new THREE.BoxGeometry(SLAB_W + 1.2, segH + 0.01, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
      );
      divider.position.set(0, topY + 0.01, zMax);
      slabGroup.add(divider);

      const labelDiv = document.createElement("div");
      labelDiv.className = "label";
      labelDiv.textContent = p.name;
      const labelObj = new CSS2DObject(labelDiv);
      labelObj.position.set(0, topY + 6.0, zCenter);
      slabGroup.add(labelObj);

      periodSegments.push({ ...p, zMin, zMax, zCenter, mesh: seg, mat: segMat });
    }

    function makeEndLabel(text, z) {
      const div = document.createElement("div");
      div.className = "label";
      div.textContent = text;
      const obj = new CSS2DObject(div);
      obj.position.set(0, topY + 14, z);
      slabGroup.add(obj);
    }
    makeEndLabel("541 Ma (Cambrian start)", -SLAB_LEN / 2);
    makeEndLabel("0 Ma (Present)", SLAB_LEN / 2);

    // -----------------------
    // Person (player)
    // -----------------------
    const player = new THREE.Group();
    scene.add(player);

    const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.55, metalness: 0.05 });
    const accentMat = new THREE.MeshStandardMaterial({ color: 0x9aa0a6, roughness: 0.7, metalness: 0.0 });

    const body = new THREE.Mesh(new THREE.CapsuleGeometry(4.2, 10, 8, 16), bodyMat);
    body.position.y = 10;
    const head = new THREE.Mesh(new THREE.SphereGeometry(3.2, 20, 20), bodyMat);
    head.position.y = 18.2;
    const feet = new THREE.Mesh(new THREE.BoxGeometry(6.8, 1.6, 6.8), accentMat);
    feet.position.y = 3.2;

    // Shirt material: white shirt + logo texture (map) swapped by period
    const shirtMat = new THREE.MeshStandardMaterial({
      color: 0xffffff,
      roughness: 0.9,
      metalness: 0.0,
      transparent: true
    });
    
    // A front-facing plane on the torso
    const shirt = new THREE.Mesh(new THREE.PlaneGeometry(9, 9), shirtMat);
    // PlaneGeometry faces +Z by default; put it slightly in front of torso
    shirt.position.set(0, 10.8, 4.9);
    shirt.rotation.y = 0;
    shirt.renderOrder = 2;
    
    // Attach to the body so it follows the character
    body.add(shirt);
    
    // Set an initial logo (optional)
    shirtMat.map = loadLogo("Triassic");
    shirtMat.needsUpdate = true;


    player.add(body, head, feet);

    const playerYStanding = topY + segH / 2 + 9.0;
    player.position.set(0, playerYStanding, maToZ(250));
    player.rotation.y = Math.PI;

    // -----------------------
    // Camera follow (track)
    // -----------------------
    // Camera stays on a "track" with fixed X/Y, Z follows player with smoothing.
    const camOffset = new THREE.Vector3(170, 110, 210); // x, y, z relative (z is + in front of player)
    const camDesired = new THREE.Vector3();
    const lookDesired = new THREE.Vector3();
    const lookCurrent = new THREE.Vector3(0, 0, player.position.z);

    function updateCamera(dt) {
      const alpha = 1 - Math.exp(-dt * 6.5); // smoothing
      camDesired.set(camOffset.x, camOffset.y, player.position.z + camOffset.z);
      camera.position.lerp(camDesired, alpha);

      // look at the slab center near the player
      lookDesired.set(0, 0, player.position.z);
      lookCurrent.lerp(lookDesired, alpha);
      camera.lookAt(lookCurrent);
    }

    // -----------------------
    // Game state
    // -----------------------
    const keys = { ArrowUp: false, ArrowDown: false };
    let score = 0;

    let currentPromptMa = null;
    let currentPromptPeriod = null;
    let sitLock = false;

    // Hover-glow state (segment under player)
    let hoveredSeg = null;

    function getPeriodForMa(ma) {
      for (const p of PERIODS) {
        if (ma <= p.start && (ma > p.end || (p.end === 0 && ma >= 0))) return p;
      }
      return null;
    }

    function getSegmentForZ(z) {
      for (const seg of periodSegments) {
        if (z >= seg.zMin && z < seg.zMax) return seg;
      }
      if (z >= periodSegments[periodSegments.length - 1].zMin) return periodSegments[periodSegments.length - 1];
      if (z < periodSegments[0].zMax) return periodSegments[0];
      return null;
    }

    function setHoveredSegment(seg) {
      if (hoveredSeg === seg) return;

      // clear previous
      if (hoveredSeg) {
        hoveredSeg.mat.emissiveIntensity = 0.0;
        hoveredSeg.mesh.scale.y = 1.0;
        hoveredSeg.mesh.position.y = topY;
      }

      hoveredSeg = seg;

      // set new
      if (hoveredSeg) {
        hoveredSeg.mat.emissiveIntensity = 0.95;    // "glow"
        hoveredSeg.mesh.scale.y = 1.35;            // slight lift emphasis
        hoveredSeg.mesh.position.y = topY + 0.25;
      }
    }

    function newPrompt() {
      const ma = +(0.1 + Math.random() * (540.8)).toFixed(1);
      const period = getPeriodForMa(ma);
      currentPromptMa = ma;
      currentPromptPeriod = period;
      promptMain.textContent = `Sit at: ${ma} million years ago (Ma)`;
    }

    function setScore(v) {
      score = v;
      scoreEl.textContent = `Score: ${score}`;
    }

    function flash(colorClass) {
      flashEl.classList.remove("green", "red", "on");
      flashEl.classList.add(colorClass, "on");
      window.setTimeout(() => flashEl.classList.remove("on"), 180);
      window.setTimeout(() => flashEl.classList.remove(colorClass), 520);
    }

    function setSitting(isSitting) {
      if (isSitting) {
        player.position.y = playerYStanding - 6.5;
        body.scale.set(1, 0.75, 1);
        head.position.y = 16.2;
        feet.position.y = 2.8;
      } else {
        player.position.y = playerYStanding;
        body.scale.set(1, 1, 1);
        head.position.y = 18.2;
        feet.position.y = 3.2;
      }
    }

    function evaluateSit() {
      const playerSeg = getSegmentForZ(player.position.z);
      const ok = playerSeg && currentPromptPeriod && (playerSeg.name === currentPromptPeriod.name);

      if (ok) { flash("green"); setScore(score + 1); newPrompt(); }
      else { flash("red"); if(score>0){setScore(score - 1);} }

    }

    // -----------------------
    // Input handling
    // -----------------------
    window.addEventListener("keydown", (e) => {
      if (e.code === "ArrowUp" || e.code === "ArrowDown" || e.code === "Space") e.preventDefault();

      if (e.code === "ArrowUp") keys.ArrowUp = true;
      if (e.code === "ArrowDown") keys.ArrowDown = true;

      if (e.code === "Space" && !sitLock) {
        sitLock = true;
        setSitting(true);
        evaluateSit();
        window.setTimeout(() => { setSitting(false); sitLock = false; }, 350);
      }
    }, { passive: false });

    window.addEventListener("keyup", (e) => {
      if (e.code === "ArrowUp") keys.ArrowUp = false;
      if (e.code === "ArrowDown") keys.ArrowDown = false;
    });

    // -----------------------
    // Animation loop
    // -----------------------
    const clock = new THREE.Clock();
    const speed = 140;

    function animate() {
      requestAnimationFrame(animate);
      const dt = Math.min(0.033, clock.getDelta());

      if (!sitLock) {
        let dz = 0;
        if (keys.ArrowUp) dz += speed * dt;
        if (keys.ArrowDown) dz -= speed * dt;
        player.position.z = THREE.MathUtils.clamp(player.position.z + dz, -SLAB_LEN / 2 + 6, SLAB_LEN / 2 - 6);
      }

      // Glow the segment under the player
      setHoveredSegment(getSegmentForZ(player.position.z));
      const seg = getSegmentForZ(player.position.z);
      updateShirtLogo(seg?.name);
      // Track camera
      updateCamera(dt);

      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }

    // -----------------------
    // Resize
    // -----------------------
    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      labelRenderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener("resize", onResize);

    // Start
    setScore(0);
    newPrompt();
    animate();
  </script>
</body>
</html>
