<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phanerozoic Ages</title>

  <!-- Import maps on GitHub Pages (works across browsers) -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- PDF generation -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
/* Berries & Cream theme (berry jam + whipped cream) */
:root{
  --bg: #190a1b;              /* deep berry night */
  --bg2:#240b26;              /* panel base */
  --cream:#fff6f0;            /* whipped cream */
  --cream2:#fde7f0;           /* rosy cream */
  --text: var(--cream);
  --muted: rgba(253,231,240,0.78);

  --berry: #a30b5d;           /* raspberry */
  --berry2:#6d0f5f;           /* plum */
  --berry3:#3b0a3e;           /* dark grape */

  --stroke: rgba(253,231,240,0.18);
  --stroke2: rgba(253,231,240,0.12);

  --shadow: 0 10px 34px rgba(0,0,0,0.42);

  --good: #3ddc97;            /* minty success (still fits) */
  --bad:  #ff3b7a;            /* berry-red fail */
}

/* Base */
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  background: radial-gradient(1200px 900px at 20% 10%, #2b0b2f 0%, var(--bg) 55%, #120513 100%);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
#app { position: fixed; inset: 0; }

/* HUD */
#prompt{
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  max-width: min(900px, calc(100vw - 32px));
  background: linear-gradient(180deg, rgba(36, 11, 38, 0.92), rgba(25, 10, 27, 0.88));
  color: var(--text);
  border: 1px solid var(--stroke);
  border-radius: 16px;
  padding: 12px 16px;
  line-height: 1.25;
  text-align: center;
  backdrop-filter: blur(8px);
  box-shadow: var(--shadow);
  user-select: none;
  pointer-events: none;
  font-size: 18px;
  z-index: 20;
}
#prompt .small{
  display: block;
  margin-top: 6px;
  font-size: 13px;
  color: var(--muted);
}

#score{
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  color: var(--cream);
  font-weight: 900;
  font-size: clamp(28px, 4vw, 44px);
  letter-spacing: 0.5px;
  text-shadow: 0 10px 26px rgba(0,0,0,0.55);
  user-select: none;
  pointer-events: none;
  z-index: 20;
}

/* Side panel */
#sidePanel{
  position: fixed;
  top: 16px;
  right: 16px;
  width: min(360px, calc(100vw - 32px));
  max-height: calc(100vh - 32px);
  overflow: auto;
  background: linear-gradient(180deg, rgba(36, 11, 38, 0.92), rgba(25, 10, 27, 0.90));
  color: var(--text);
  border: 1px solid var(--stroke);
  border-radius: 16px;
  padding: 12px 12px 10px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(8px);
  user-select: none;
  z-index: 20;
}
#sidePanel h3{
  margin: 0 0 10px;
  font-size: 15px;
  letter-spacing: 0.3px;
  color: rgba(255,246,240,0.96);
}

/* Key/Value */
.kv{
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 6px 10px;
  font-size: 13px;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--stroke2);
}
.kv div:nth-child(odd){ color: var(--muted); }
.kv div:nth-child(even){ font-weight: 800; }

/* Tier table */
.tierTable{
  width: 100%;
  border-collapse: collapse;
  font-size: 12.5px;
}
.tierTable th, .tierTable td{
  padding: 8px 6px;
  border-bottom: 1px solid var(--stroke2);
  text-align: left;
  vertical-align: top;
}
.tierTable th{
  font-size: 12px;
  color: rgba(253,231,240,0.70);
  font-weight: 800;
}
.tierRow.active td{
  background: rgba(163, 11, 93, 0.14);
}

/* Pills */
.pill{
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 900;
  background: rgba(163, 11, 93, 0.18);
  border: 1px solid rgba(253,231,240,0.20);
  color: rgba(255,246,240,0.96);
  white-space: nowrap;
}

/* Full-screen overlays */
.overlay{
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: radial-gradient(1200px 900px at 25% 10%, rgba(163, 11, 93, 0.26) 0%, rgba(0,0,0,0.60) 55%, rgba(0,0,0,0.72) 100%);
  backdrop-filter: blur(6px);
  z-index: 40;
}
.panel{
  width: min(920px, calc(100vw - 32px));
  max-height: calc(100vh - 32px);
  overflow: auto;
  background: linear-gradient(180deg, rgba(36, 11, 38, 0.94), rgba(25, 10, 27, 0.92));
  border: 1px solid var(--stroke);
  border-radius: 18px;
  box-shadow: 0 18px 70px rgba(0,0,0,0.55);
  color: var(--text);
  padding: 18px;
}
.panel h1{
  margin: 0 0 10px;
  font-size: 24px;
  letter-spacing: 0.4px;
}
.panel p{
  margin: 8px 0;
  color: rgba(253,231,240,0.82);
  line-height: 1.35;
}
.row{ display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
@media (max-width: 900px){ .row{ grid-template-columns: 1fr; } }

.card{
  background: linear-gradient(180deg, rgba(255,246,240,0.06), rgba(163, 11, 93, 0.08));
  border: 1px solid rgba(253,231,240,0.12);
  border-radius: 14px;
  padding: 12px;
}
.card h2{ margin: 0 0 8px; font-size: 16px; }

/* Buttons */
.btnRow{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
button{
  appearance: none;
  border: 1px solid rgba(253,231,240,0.20);
  background: rgba(255,246,240,0.08);
  color: var(--cream);
  font-weight: 900;
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 8px 22px rgba(0,0,0,0.22);
}
button.primary{
  background: linear-gradient(180deg, rgba(163, 11, 93, 0.38), rgba(109, 15, 95, 0.30));
  border-color: rgba(253,231,240,0.28);
}
button.warn{
  background: linear-gradient(180deg, rgba(255, 59, 122, 0.28), rgba(163, 11, 93, 0.22));
  border-color: rgba(255, 59, 122, 0.40);
}
button:active{ transform: translateY(1px); }

/* Inputs */
input[type="text"]{
  width: 100%;
  box-sizing: border-box;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(253,231,240,0.18);
  background: rgba(0,0,0,0.22);
  color: var(--cream);
  font-weight: 700;
  outline: none;
}
input[type="text"]::placeholder{ color: rgba(253,231,240,0.55); }
input[type="text"]:focus{
  border-color: rgba(253,231,240,0.35);
  box-shadow: 0 0 0 3px rgba(163, 11, 93, 0.22);
}

.muted{ color: rgba(253,231,240,0.72); font-size: 13px; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

/* Flash feedback */
#flash{
  position: fixed;
  inset: 0;
  background: transparent;
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease;
  z-index: 30;
}
#flash.on{ opacity: 0.78; }
#flash.green{ background: var(--good); }
#flash.red{ background: var(--bad); }

/* +points animation */
#fxLayer{ position:fixed; inset:0; pointer-events:none; z-index: 25; }
.pop{
  position:absolute;
  left:50%;
  bottom:70px;
  transform:translateX(-50%) translateY(0) scale(1);
  font-weight: 950;
  font-size: clamp(22px, 3.2vw, 36px);
  color: var(--cream);
  text-shadow: 0 10px 26px rgba(0,0,0,0.55);
  opacity:0;
  will-change: transform, opacity;
}
.pop.show{ animation: popFloat 650ms ease-out forwards; }
@keyframes popFloat{
  0%   { opacity:0; transform:translateX(-50%) translateY(10px) scale(0.92); }
  15%  { opacity:1; transform:translateX(-50%) translateY(0px)  scale(1.05); }
  100% { opacity:0; transform:translateX(-50%) translateY(-55px) scale(1.00); }
}

/* Period labels */
.label{
  padding: 4px 8px;
  border-radius: 10px;
  background: rgba(36, 11, 38, 0.62);
  border: 1px solid rgba(253,231,240,0.22);
  color: rgba(255,246,240,0.96);
  font-size: 12px;
  white-space: nowrap;
  user-select: none;
  pointer-events: none;
  text-shadow: 0 2px 10px rgba(0,0,0,0.45);
}

.hidden { display: none !important; }

  </style>
</head>

<body>
  <div id="app"></div>
  <div id="flash"></div>
  <div id="fxLayer"></div>

  <div id="prompt" class="hidden">
    <div id="promptMain">Loading…</div>
    <span class="small">Move: ↑ / ↓ &nbsp;•&nbsp; Sit: Space</span>
  </div>

  <div id="score" class="hidden">Score: 0</div>

  <div id="sidePanel" class="hidden">
    <h3>Scoring & Tiers</h3>
    <div class="kv">
      <div>Path</div><div id="uiPath">—</div>
      <div>Question</div><div id="uiQ">—</div>
      <div>Streak</div><div id="uiStreak">0</div>
      <div>Next correct</div><div id="uiNext">+1</div>
      <div>Max possible</div><div id="uiMax">—</div>
      <div>Grade cap</div><div id="uiCap">—</div>
    </div>
    <table class="tierTable">
      <thead>
        <tr><th>Tier title</th><th>Min score</th><th>Gradebook</th></tr>
      </thead>
      <tbody id="tierBody"></tbody>
    </table>
    <p class="muted" style="margin-top:10px">
      Wrong seat: <span class="mono">-1</span> and streak resets.
    </p>
  </div>

  <!-- Start / Path selection -->
  <div id="startOverlay" class="overlay">
    <div class="panel">
      <h1>Phanerozoic Ages Mastery</h1>
      <p>
        Walk the Phanerozoic timeline and <b>sit</b> in the correct geologic period for each prompt (in <b>Ma</b>, millions of years ago).
      </p>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2>Student name (for certificate)</h2>
          <input id="studentName" type="text" placeholder="Type your name..." maxlength="64" />
          <p class="muted">This prints on the PDF certificate at the end.</p>
        </div>

        <div class="card">
          <h2>Choose your challenge</h2>
          <div class="btnRow">
            <button id="btnNovice" class="primary">Novice Path (10 questions)</button>
            <button id="btnMastery" class="primary">Mastery Path (20 questions)</button>
          </div>
          <p class="muted">
            You will complete the full set, then decide to retry or settle and print your certificate.
          </p>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="card">
          <h2>How scoring works (combo = exponential)</h2>
          <p>
            Each correct answer increases your <b>streak</b> and awards:
            <span class="mono">1, 2, 4, 8, 16, …</span> points (doubling each time).
          </p>
          <p>
            A wrong answer is <span class="mono">-1</span> point and your streak resets to 0.
          </p>
          <p class="muted">
            Perfect combo maximum for <span class="mono">N</span> questions is <span class="mono">2^N − 1</span>.
          </p>
        </div>

        <div class="card">
          <h2>Tiers → Gradebook score (out of 10)</h2>
          <p>
            Your final <b>Tier Title</b> is based on your <b>final score</b>. Each tier converts to a gradebook score out of 10.
          </p>
          <p class="muted">
            You’ll see the tier table in-game in the right panel, and your current tier is highlighted live.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- End screen -->
  <div id="endOverlay" class="overlay hidden">
    <div class="panel">
      <h1>Challenge complete</h1>
      <div class="row" style="margin-top:12px">
        <div class="card">
          <h2>Results</h2>
          <p><b>Final score:</b> <span id="endScore" class="mono"></span></p>
          <p><b>Tier earned:</b> <span id="endTier" class="pill"></span></p>
          <p><b>Gradebook score:</b> <span id="endGrade" class="mono"></span> / 10</p>
          <p class="muted">If you settle, your certificate will print these values.</p>
        </div>

        <div class="card">
          <h2>Decision</h2>
          <p><b>Try again for greater greatness?</b> (restarts the same path)</p>
          <div class="btnRow">
            <button id="btnTryAgain" class="primary">Try again for greater greatness</button>
            <button id="btnSettle" class="warn">Settle for less than perfection (print certificate)</button>
          </div>
          <p class="muted" style="margin-top:10px">
            If the PDF doesn’t open, your browser may block popups. You can still download it.
          </p>
        </div>
      </div>

      <div class="btnRow" style="margin-top:12px">
        <button id="btnBackToStart">Back to path selection</button>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { CSS2DRenderer, CSS2DObject } from "three/addons/renderers/CSS2DRenderer.js";

    // -----------------------
    // Periods (Ma) and shirt logos
    // -----------------------
    const PERIODS = [
      { name: "Cambrian",      start: 539.0,    end: 485,   color: 0x2ecc71 },
      { name: "Ordovician",    start: 485,      end: 444,   color: 0x27ae60 },
      { name: "Silurian",      start: 444,      end: 419,   color: 0x16a085 },
      { name: "Devonian",      start: 419,      end: 359,   color: 0x1abc9c },
      { name: "Carboniferous", start: 359,      end: 299,   color: 0x3498db },
      { name: "Permian",       start: 299,      end: 252,   color: 0x9b59b6 },
      { name: "Triassic",      start: 252,      end: 201,   color: 0xe67e22 },
      { name: "Jurassic",      start: 201,      end: 145,   color: 0xf1c40f },
      { name: "Cretaceous",    start: 145,      end: 66,    color: 0xf39c12 },
      { name: "Paleogene",     start: 66,       end: 23,    color: 0xe74c3c },
      { name: "Neogene",       start: 23,       end: 2.6,   color: 0xc0392b },
      { name: "Quaternary",    start: 2.6,      end: 0.0,   color: 0xecf0f1 }
    ];

    // Place your downloaded period PNGs here:
    // assets/logos/Cambrian.png ... assets/logos/Quaternary.png
    const LOGO_PATHS = Object.fromEntries(PERIODS.map(p => [p.name, `${p.name}.png`]));
    const texLoader = new THREE.TextureLoader();
    const logoTexCache = new Map();

    function loadLogo(periodName) {
      if (!periodName) return null;
      if (logoTexCache.has(periodName)) return logoTexCache.get(periodName);
      const url = LOGO_PATHS[periodName];
      if (!url) return null;
      const t = texLoader.load(url);
      t.colorSpace = THREE.SRGBColorSpace;
      t.anisotropy = 8;
      logoTexCache.set(periodName, t);
      return t;
    }

    // -----------------------
    // Tier definitions (score -> title -> gradebook points out of 10)
    // Thresholds use (2^k - 1) milestones to reflect the combo/exponential nature.
    // -----------------------
    // One identical tier table for both paths (titles + min scores + displayed /10)
    // Built around the 20-question "perfect combo" landscape.
    const TIERS = [
      { title: "Cambrian Tourist",        minScore: 0,        grade: 2 },
      { title: "Carboniferous Crawler",   minScore: 255,      grade: 4 },   // 2^8 - 1
      { title: "Permian Prototype",       minScore: 4095,     grade: 6 },   // 2^12 - 1
      { title: "Cretaceous Creature",     minScore: 65535,    grade: 8 },   // 2^16 - 1
      { title: "Neogene Elite",           minScore: 262143,   grade: 9 },   // 2^18 - 1
      { title: "Quaternary Grandmaster",  minScore: 1048575,  grade: 10 }   // 2^20 - 1
    ];
    

    function getTiersForN(_n) { return TIERS; }
    
    function getTierForScore(score, _n) {
      const s = Math.max(0, Math.trunc(score));
      let best = TIERS[0];
      for (const t of TIERS) if (s >= t.minScore) best = t;
      return best;
    }

    // Novice: recorded gradebook score cannot exceed "passing".
    // Change this if your passing definition differs.
    const NOVICE_GRADE_CAP = 7; // out of 10
    
    function isNovicePath() {
      return totalQuestions === 10; // Novice Path = 10 questions
    }
    
    function gradebookScoreFromTier(tierGrade) {
      return isNovicePath() ? Math.min(tierGrade, NOVICE_GRADE_CAP) : tierGrade;
    }


    function formatInt(n) {
      return Math.trunc(n).toLocaleString("en-US");
    }

    function isPerfectScore() {
      // Perfect = all correct in a row (combo all N): 2^N - 1
      const perfect = (2 ** totalQuestions) - 1;
      return score >= perfect;
    }
    
    function updateSettleButtonLabel() {
      btnSettle.textContent = isPerfectScore()
        ? "Print your Certificate of Perfection!"
        : "Settle for less than perfection (print certificate)";
    }


    // -----------------------
    // DOM
    // -----------------------
    const app = document.getElementById("app");
    const promptEl = document.getElementById("prompt");
    const promptMain = document.getElementById("promptMain");
    const scoreEl = document.getElementById("score");
    const sidePanel = document.getElementById("sidePanel");
    const tierBody = document.getElementById("tierBody");
    const fxLayer = document.getElementById("fxLayer");
    const flashEl = document.getElementById("flash");

    const startOverlay = document.getElementById("startOverlay");
    const endOverlay = document.getElementById("endOverlay");

    const studentNameInput = document.getElementById("studentName");
    const btnNovice = document.getElementById("btnNovice");
    const btnMastery = document.getElementById("btnMastery");

    const uiPath = document.getElementById("uiPath");
    const uiQ = document.getElementById("uiQ");
    const uiStreak = document.getElementById("uiStreak");
    const uiNext = document.getElementById("uiNext");
    const uiMax = document.getElementById("uiMax");

    const endScore = document.getElementById("endScore");
    const endTier = document.getElementById("endTier");
    const endGrade = document.getElementById("endGrade");
    const btnTryAgain = document.getElementById("btnTryAgain");
    const btnSettle = document.getElementById("btnSettle");
    const btnBackToStart = document.getElementById("btnBackToStart");

    // -----------------------
    // Scene setup
    // -----------------------
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b0f14, 260, 900);

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2200);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = "fixed";
    labelRenderer.domElement.style.inset = "0";
    labelRenderer.domElement.style.pointerEvents = "none";
    app.appendChild(labelRenderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(150, 200, 80);
    scene.add(dir);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(2400, 2400),
      new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -40;
    scene.add(ground);

    // -----------------------
    // Slab layout (make thin periods playable)
    // -----------------------
    const SLAB_LEN = 780;
    const SLAB_W = 120;
    const SLAB_H = 18;

    const MIN_SEG_LEN = 26; // makes Quaternary hittable

    function buildZLayout(periods, slabLen) {
      const durations = periods.map(p => p.start - p.end);
      const totalDur = durations.reduce((a, b) => a + b, 0);

      const n = periods.length;
      const minTotal = MIN_SEG_LEN * n;
      const remainder = Math.max(0, slabLen - minTotal);

      const segLens = durations.map(d => MIN_SEG_LEN + (totalDur ? remainder * (d / totalDur) : 0));

      let z = -slabLen / 2;
      const out = [];
      for (let i = 0; i < periods.length; i++) {
        const len = (i === periods.length - 1) ? (slabLen / 2 - z) : segLens[i];
        const zMin = z;
        const zMax = z + len;
        out.push({ zMin, zMax, zCenter: (zMin + zMax) / 2, segLen: Math.max(1, zMax - zMin) });
        z = zMax;
      }
      return out;
    }

    const slabGroup = new THREE.Group();
    scene.add(slabGroup);

    const baseSlab = new THREE.Mesh(
      new THREE.BoxGeometry(SLAB_W, SLAB_H, SLAB_LEN),
      new THREE.MeshStandardMaterial({ color: 0x232a33, roughness: 0.85, metalness: 0.05 })
    );
    slabGroup.add(baseSlab);

    const topY = SLAB_H / 2 + 0.6;
    const segH = 1.2;

    const layout = buildZLayout(PERIODS, SLAB_LEN);
    const periodSegments = [];

    for (let i = 0; i < PERIODS.length; i++) {
      const p = PERIODS[i];
      const L = layout[i];

      const segMat = new THREE.MeshStandardMaterial({
        color: p.color,
        roughness: 0.65,
        metalness: 0.05,
        emissive: new THREE.Color(p.color),
        emissiveIntensity: 0.0
      });

      const seg = new THREE.Mesh(
        new THREE.BoxGeometry(SLAB_W + 0.6, segH, L.segLen),
        segMat
      );
      seg.position.set(0, topY, L.zCenter);
      slabGroup.add(seg);

      if (i !== PERIODS.length - 1) {
        const divider = new THREE.Mesh(
          new THREE.BoxGeometry(SLAB_W + 1.2, segH + 0.01, 0.8),
          new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
        );
        divider.position.set(0, topY + 0.01, L.zMax);
        slabGroup.add(divider);
      }

      const labelDiv = document.createElement("div");
      labelDiv.className = "label";
      labelDiv.textContent = p.name;
      const labelObj = new CSS2DObject(labelDiv);
      labelObj.position.set(0, topY + 6.0, L.zCenter);
      slabGroup.add(labelObj);

      periodSegments.push({
        ...p,
        zMin: L.zMin,
        zMax: L.zMax,
        zCenter: L.zCenter,
        mesh: seg,
        mat: segMat
      });
    }

    function makeEndLabel(text, z) {
      const div = document.createElement("div");
      div.className = "label";
      div.textContent = text;
      const obj = new CSS2DObject(div);
      obj.position.set(0, topY + 14, z);
      slabGroup.add(obj);
    }
    makeEndLabel("Older (Cambrian)", -SLAB_LEN / 2);
    makeEndLabel("Present (0 Ma)", SLAB_LEN / 2);

    // -----------------------
    // Player
    // -----------------------
    const player = new THREE.Group();
    scene.add(player);

    const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.55, metalness: 0.05 });
    const accentMat = new THREE.MeshStandardMaterial({ color: 0x9aa0a6, roughness: 0.7, metalness: 0.0 });

    const body = new THREE.Mesh(new THREE.CapsuleGeometry(4.2, 10, 8, 16), bodyMat);
    body.position.y = 10;
    const head = new THREE.Mesh(new THREE.SphereGeometry(3.2, 20, 20), bodyMat);
    head.position.y = 18.2;
    const feet = new THREE.Mesh(new THREE.BoxGeometry(6.8, 1.6, 6.8), accentMat);
    feet.position.y = 3.2;

    player.add(body, head, feet);

    const playerYStanding = topY + segH / 2 + 9.0;
    player.position.set(0, playerYStanding, periodSegments.find(s => s.name === "Jurassic")?.zCenter ?? 0);
    player.rotation.y = Math.PI; // keep consistent facing

    // Shirt (logo)
    const shirtMat = new THREE.MeshBasicMaterial({
      transparent: true,
      alphaTest: 0.05,
      side: THREE.DoubleSide
    });
    const shirt = new THREE.Mesh(new THREE.PlaneGeometry(9, 9), shirtMat);
    shirt.position.set(0, 10.8, 6.6);  // outside torso
    shirt.rotation.y = Math.PI;        // initial facing (because player faces -Z)
    body.add(shirt);

    let currentLogoName = null;
    function updateShirtLogo(periodName) {
      if (!periodName || periodName === currentLogoName) return;
      const t = loadLogo(periodName);
      if (t) {
        shirtMat.map = t;
        shirtMat.needsUpdate = true;
        currentLogoName = periodName;
      }
    }

    // Billboard shirt to camera around Y so it always faces viewer
    function faceShirtToCameraUpright() {
      const shirtWorld = new THREE.Vector3();
      shirt.getWorldPosition(shirtWorld);

      const camLocal = body.worldToLocal(camera.position.clone());
      const shirtLocal = body.worldToLocal(shirtWorld.clone());

      const dx = camLocal.x - shirtLocal.x;
      const dz = camLocal.z - shirtLocal.z;
      shirt.rotation.set(0, Math.atan2(dx, dz), 0);
    }

    // -----------------------
    // Camera follow (track)
    // -----------------------
    const camOffset = new THREE.Vector3(170, 110, 210);
    const camDesired = new THREE.Vector3();
    const lookDesired = new THREE.Vector3();
    const lookCurrent = new THREE.Vector3(0, 0, player.position.z);

    function updateCamera(dt) {
      const alpha = 1 - Math.exp(-dt * 6.5);
      camDesired.set(camOffset.x, camOffset.y, player.position.z + camOffset.z);
      camera.position.lerp(camDesired, alpha);

      lookDesired.set(0, 0, player.position.z);
      lookCurrent.lerp(lookDesired, alpha);
      camera.lookAt(lookCurrent);
    }

    // -----------------------
    // Game logic (finite-question challenge + combo scoring)
    // -----------------------
    const keys = { ArrowUp: false, ArrowDown: false };
    let isPlaying = false;

    let totalQuestions = 0;
    let answered = 0;

    let score = 0;
    let streak = 0;

    let currentPromptMa = null;
    let currentPromptPeriod = null;
    let sitLock = false;

    let hoveredSeg = null;

    function pointsForStreak(streakCount) {
      return 2 ** Math.max(0, streakCount - 1); // 1,2,4,8,...
    }

    function setScore(v) {
      score = v;
      scoreEl.textContent = `Score: ${formatInt(score)}`;
      updateTierUI();
    }

    function showPointsPop(text) {
      const el = document.createElement("div");
      el.className = "pop";
      el.textContent = text;
      fxLayer.appendChild(el);
      requestAnimationFrame(() => el.classList.add("show"));
      setTimeout(() => el.remove(), 750);
    }

    function flash(colorClass) {
      flashEl.classList.remove("green", "red", "on");
      flashEl.classList.add(colorClass, "on");
      window.setTimeout(() => flashEl.classList.remove("on"), 180);
      window.setTimeout(() => flashEl.classList.remove(colorClass), 520);
    }

    function getPeriodForMa(ma) {
      for (const p of PERIODS) {
        if (ma <= p.start && (ma > p.end || (p.end === 0 && ma >= 0))) return p;
      }
      return null;
    }

    function getSegmentForZ(z) {
      for (const seg of periodSegments) {
        if (z >= seg.zMin && z < seg.zMax) return seg;
      }
      if (z >= periodSegments[periodSegments.length - 1].zMin) return periodSegments[periodSegments.length - 1];
      if (z < periodSegments[0].zMax) return periodSegments[0];
      return null;
    }

    function setHoveredSegment(seg) {
      if (hoveredSeg === seg) return;

      if (hoveredSeg) {
        hoveredSeg.mat.emissiveIntensity = 0.0;
        hoveredSeg.mesh.scale.y = 1.0;
        hoveredSeg.mesh.position.y = topY;
      }
      hoveredSeg = seg;

      if (hoveredSeg) {
        hoveredSeg.mat.emissiveIntensity = 0.95;
        hoveredSeg.mesh.scale.y = 1.35;
        hoveredSeg.mesh.position.y = topY + 0.25;
      }
    }

    function newPrompt() {
      const ma = +(0.1 + Math.random() * (540.8)).toFixed(1);
      const period = getPeriodForMa(ma);
      currentPromptMa = ma;
      currentPromptPeriod = period;

      promptMain.textContent = `Question ${answered + 1} of ${totalQuestions}: Sit at ${ma} million years ago (Ma)`;
      updateHUD();
    }

    function updateHUD() {
      uiPath.textContent = totalQuestions === 20 ? "Mastery Path (20)" : "Novice Path (10)";
      uiQ.textContent = `${answered + 1} / ${totalQuestions}`;
      uiStreak.textContent = String(streak);
      uiNext.textContent = `+${formatInt(pointsForStreak(streak + 1))}`;
      uiMax.textContent = formatInt((2 ** totalQuestions) - 1);
      uiCap.textContent = isNovicePath() ? `Yes (max ${NOVICE_GRADE_CAP}/10)` : "No";

    }

    function renderTierTable() {
      const tiers = getTiersForN(totalQuestions);
      tierBody.innerHTML = "";
      for (const t of tiers) {
        const tr = document.createElement("tr");
        tr.dataset.minScore = String(t.minScore);
        tr.innerHTML = `
          <td><span class="pill">${t.title}</span></td>
          <td class="mono">${formatInt(t.minScore)}</td>
          <td class="mono">${t.grade}/10</td>
        `;
        tierBody.appendChild(tr);
      }
      updateTierUI();
    }

    function updateTierUI() {
      if (!totalQuestions) return;
      const tiers = getTiersForN(totalQuestions);
      const tier = getTierForScore(score, totalQuestions);

      const rows = tierBody.querySelectorAll("tr");
      rows.forEach(r => r.classList.remove("active"));
      for (const r of rows) {
        const min = Number(r.dataset.minScore || "0");
        if (min === tier.minScore) r.classList.add("active");
      }
    }

    function setSitting(isSitting) {
      if (isSitting) {
        player.position.y = playerYStanding - 6.5;
        body.scale.set(1, 0.75, 1);
        head.position.y = 16.2;
        feet.position.y = 2.8;
      } else {
        player.position.y = playerYStanding;
        body.scale.set(1, 1, 1);
        head.position.y = 18.2;
        feet.position.y = 3.2;
      }
    }

    function finishGame() {
      isPlaying = false;
      sitLock = false;
      promptEl.classList.add("hidden");

      const tier = getTierForScore(score, totalQuestions);
      endScore.textContent = formatInt(score);
      endTier.textContent = tier.title;
      endGrade.textContent = String(gradebookScoreFromTier(tier.grade));
      updateSettleButtonLabel();
      endOverlay.classList.remove("hidden");
    }

    function evaluateSit() {
      const playerSeg = getSegmentForZ(player.position.z);
      const ok = playerSeg && currentPromptPeriod && (playerSeg.name === currentPromptPeriod.name);

      if (ok) {
        streak += 1;
        const gained = pointsForStreak(streak);
        flash("green");
        setScore(score + gained);
        showPointsPop(`+${formatInt(gained)}`);
        newPrompt();
        answered += 1;
      } else {
        streak = 0;
        flash("red");
        if(score>0){setScore(score - 1);}
        showPointsPop(`-1`);
      }

      

      if (answered >= totalQuestions) {
        finishGame();
      } else {
        
      }
    }

    // -----------------------
    // Start / Restart
    // -----------------------
    function startGame(nQuestions) {
      totalQuestions = nQuestions;
      answered = 0;
      streak = 0;
      setScore(0);

      // UI
      startOverlay.classList.add("hidden");
      endOverlay.classList.add("hidden");
      promptEl.classList.remove("hidden");
      scoreEl.classList.remove("hidden");
      sidePanel.classList.remove("hidden");

      renderTierTable();
      updateHUD();

      // place player mid-ish
      player.position.z = periodSegments.find(s => s.name === "Jurassic")?.zCenter ?? 0;

      // prime hovered/logo
      const seg = getSegmentForZ(player.position.z);
      setHoveredSegment(seg);
      updateShirtLogo(seg?.name);

      isPlaying = true;
      newPrompt();
    }

    function backToStart() {
      isPlaying = false;
      totalQuestions = 0;
      answered = 0;
      streak = 0;
      setScore(0);

      promptEl.classList.add("hidden");
      scoreEl.classList.add("hidden");
      sidePanel.classList.add("hidden");
      endOverlay.classList.add("hidden");
      startOverlay.classList.remove("hidden");
    }

    btnNovice.addEventListener("click", () => startGame(10));
    btnMastery.addEventListener("click", () => startGame(20));

    btnTryAgain.addEventListener("click", () => {
      if (totalQuestions) startGame(totalQuestions);
    });

    btnBackToStart.addEventListener("click", () => backToStart());

    // -----------------------
    // Certificate PDF
    // -----------------------
    function generateCertificatePDF() {
      const name = (studentNameInput.value || "").trim() || "Student";
      const tier = getTierForScore(score, totalQuestions);
      const pathLabel = totalQuestions === 20 ? "Mastery Path (20 questions)" : "Novice Path (10 questions)";
      const grade = gradebookScoreFromTier(tier.grade);

      const jspdf = window.jspdf;
      if (!jspdf || !jspdf.jsPDF) {
        alert("jsPDF did not load. Check that the jsPDF CDN script is reachable.");
        return;
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "letter" });

      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();

      // Background + border
      doc.setFillColor(15, 19, 26);
      doc.rect(0, 0, W, H, "F");

      doc.setDrawColor(255, 255, 255);
      doc.setLineWidth(2);
      doc.rect(30, 30, W - 60, H - 60);

      doc.setLineWidth(1);
      doc.setDrawColor(255, 255, 255);
      doc.rect(44, 44, W - 88, H - 88);

      // Title
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(34);
      doc.text("Certificate of Achievement", W / 2, 110, { align: "center" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.setTextColor(200, 205, 215);
      doc.text("Phanerozoic Mastery Path Challenge", W / 2, 140, { align: "center" });

      // Name
      doc.setFont("helvetica", "bold");
      doc.setFontSize(28);
      doc.setTextColor(255, 255, 255);
      doc.text(name, W / 2, 210, { align: "center" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.setTextColor(200, 205, 215);
      doc.text("has earned the title:", W / 2, 240, { align: "center" });

      // Tier title
      doc.setFont("helvetica", "bold");
      doc.setFontSize(24);
      doc.setTextColor(255, 255, 255);
      doc.text(tier.title, W / 2, 280, { align: "center" });

      // Details
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.setTextColor(220, 225, 235);

      const dateStr = new Date().toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });

      const lines = [
        `Path: ${pathLabel}`,
        `Final Score: ${formatInt(score)}`,
        `Gradebook Score: ${grade} / 10`,
        `Date: ${dateStr}`
      ];

      const y0 = 340;
      const lh = 22;
      for (let i = 0; i < lines.length; i++) {
        doc.text(lines[i], W / 2, y0 + i * lh, { align: "center" });
      }

      // Signature line
      doc.setDrawColor(200, 205, 215);
      doc.line(W/2 - 170, H - 140, W/2 + 170, H - 140);
      doc.setTextColor(200, 205, 215);
      doc.setFontSize(12);
      doc.text("Instructor / Course", W / 2, H - 120, { align: "center" });

      const fileName = `${name.replace(/[^\w\-]+/g, "_")}_Phanerozoic_Certificate.pdf`;

      // Open in a new tab for printing (best effort) + download
      const blob = doc.output("blob");
      const url = URL.createObjectURL(blob);
      try { window.open(url, "_blank", "noopener"); } catch {}
      doc.save(fileName);

      // cleanup later
      setTimeout(() => URL.revokeObjectURL(url), 30000);
    }

    btnSettle.addEventListener("click", () => generateCertificatePDF());

    // -----------------------
    // Input
    // -----------------------
    window.addEventListener("keydown", (e) => {
      if (!isPlaying) return;

      if (e.code === "ArrowUp" || e.code === "ArrowDown" || e.code === "Space") e.preventDefault();

      if (e.code === "ArrowUp") keys.ArrowUp = true;
      if (e.code === "ArrowDown") keys.ArrowDown = true;

      if (e.code === "Space" && !sitLock) {
        sitLock = true;
        setSitting(true);
        evaluateSit();
        window.setTimeout(() => { setSitting(false); sitLock = false; }, 320);
      }
    }, { passive: false });

    window.addEventListener("keyup", (e) => {
      if (e.code === "ArrowUp") keys.ArrowUp = false;
      if (e.code === "ArrowDown") keys.ArrowDown = false;
    });

    // -----------------------
    // Animate
    // -----------------------
    const clock = new THREE.Clock();
    const speed = 140;
    const PLAYER_Z_MARGIN = 3.5;

    function animate() {
      requestAnimationFrame(animate);
      const dt = Math.min(0.033, clock.getDelta());

      if (isPlaying && !sitLock) {
        let dz = 0;
        if (keys.ArrowUp) dz += speed * dt;   // toward present
        if (keys.ArrowDown) dz -= speed * dt; // toward older

        player.position.z = THREE.MathUtils.clamp(
          player.position.z + dz,
          -SLAB_LEN / 2 + PLAYER_Z_MARGIN,
           SLAB_LEN / 2 - PLAYER_Z_MARGIN
        );
      }

      const seg = getSegmentForZ(player.position.z);
      setHoveredSegment(seg);
      updateShirtLogo(seg?.name);

      updateCamera(dt);
      faceShirtToCameraUpright();

      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      labelRenderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener("resize", onResize);

    // Boot: show menu; render background scene immediately
    camera.position.set(170, 110, 210);
    camera.lookAt(0, 0, player.position.z);
    animate();
  </script>
</body>
</html>
