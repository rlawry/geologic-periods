<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phanerozoic Sit-in-the-Period (Three.js)</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { position: fixed; inset: 0; }

    /* UI overlays */
    #prompt {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(840px, calc(100vw - 32px));
      background: rgba(20, 26, 34, 0.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px 16px;
      line-height: 1.25;
      text-align: center;
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
      user-select: none;
      pointer-events: none;
      font-size: 18px;
    }
    #prompt .small {
      display: block;
      margin-top: 6px;
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }

    #score {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-weight: 800;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: 0.5px;
      text-shadow: 0 6px 20px rgba(0,0,0,0.45);
      user-select: none;
      pointer-events: none;
    }

    #flash {
      position: fixed;
      inset: 0;
      background: transparent;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    #flash.on { opacity: 0.85; }
    #flash.green { background: #00c853; }
    #flash.red { background: #ff1744; }

    /* Period labels (CSS2DRenderer) */
    .label {
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
      pointer-events: none;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    /* Small corner hint (optional, unobtrusive) */
    #hint {
      position: fixed;
      left: 16px;
      bottom: 16px;
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      user-select: none;
      pointer-events: none;
      max-width: 320px;
      line-height: 1.25;
    }
  </style>
</head>

<body>
  <div id="app"></div>
  <div id="flash"></div>

  <div id="prompt">
    <div id="promptMain">Loading…</div>
    <span class="small">Move: ↑ / ↓ &nbsp;•&nbsp; Sit: Space</span>
  </div>

  <div id="score">Score: 0</div>
  <div id="hint">Older end: Cambrian (541 Ma) ← &nbsp;&nbsp;→ Present (0 Ma): Quaternary</div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { CSS2DRenderer, CSS2DObject } from "https://unpkg.com/three@0.160.0/examples/jsm/renderers/CSS2DRenderer.js";

    // -----------------------
    // Phanerozoic periods (Ma)
    // -----------------------
    // Ranges: startMa (older) -> endMa (younger)
    const PERIODS = [
      { name: "Cambrian",      start: 541.0,    end: 485.4,  color: 0x2ecc71 },
      { name: "Ordovician",    start: 485.4,    end: 443.8,  color: 0x27ae60 },
      { name: "Silurian",      start: 443.8,    end: 419.2,  color: 0x16a085 },
      { name: "Devonian",      start: 419.2,    end: 358.9,  color: 0x1abc9c },
      { name: "Carboniferous", start: 358.9,    end: 298.9,  color: 0x3498db },
      { name: "Permian",       start: 298.9,    end: 251.902,color: 0x9b59b6 },
      { name: "Triassic",      start: 251.902,  end: 201.36, color: 0xe67e22 },
      { name: "Jurassic",      start: 201.36,   end: 145.0,  color: 0xf1c40f },
      { name: "Cretaceous",    start: 145.0,    end: 66.0,   color: 0xf39c12 },
      { name: "Paleogene",     start: 66.0,     end: 23.03,  color: 0xe74c3c },
      { name: "Neogene",       start: 23.03,    end: 2.58,   color: 0xc0392b },
      { name: "Quaternary",    start: 2.58,     end: 0.0,    color: 0xecf0f1 }
    ];

    // -----------------------
    // Scene setup
    // -----------------------
    const app = document.getElementById("app");
    const promptMain = document.getElementById("promptMain");
    const scoreEl = document.getElementById("score");
    const flashEl = document.getElementById("flash");

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b0f14, 250, 800);

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
    camera.position.set(120, 85, 170);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = "fixed";
    labelRenderer.domElement.style.inset = "0";
    labelRenderer.domElement.style.pointerEvents = "none";
    app.appendChild(labelRenderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.enablePan = false;
    controls.minDistance = 90;
    controls.maxDistance = 520;
    controls.maxPolarAngle = Math.PI * 0.48;

    // Lighting
    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dir = new THREE.DirectionalLight(0xffffff, 0.85);
    dir.position.set(140, 180, 60);
    scene.add(dir);

    // Subtle ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(2000, 2000),
      new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -40;
    scene.add(ground);

    // -----------------------
    // Slab geometry + segments
    // -----------------------
    const TOTAL_MA = 541.0;
    const SLAB_LEN = 780;      // world units along Z
    const SLAB_W = 120;        // world units along X
    const SLAB_H = 18;         // world units along Y

    function maToZ(ma) {
      // ma=541 -> -SLAB_LEN/2 (older end)
      // ma=0   -> +SLAB_LEN/2 (present end)
      const t = (TOTAL_MA - ma) / TOTAL_MA;
      return (t * SLAB_LEN) - SLAB_LEN / 2;
    }

    const slabGroup = new THREE.Group();
    scene.add(slabGroup);

    // Base slab (dark)
    const baseSlab = new THREE.Mesh(
      new THREE.BoxGeometry(SLAB_W, SLAB_H, SLAB_LEN),
      new THREE.MeshStandardMaterial({ color: 0x232a33, roughness: 0.85, metalness: 0.05 })
    );
    baseSlab.position.y = 0;
    slabGroup.add(baseSlab);

    // Colored period "rod" segments (thin layer on top)
    const topY = SLAB_H / 2 + 0.6;
    const segH = 1.2;

    const periodSegments = []; // store zMin/zMax for hit testing & labels
    for (const p of PERIODS) {
      const zA = maToZ(p.start);
      const zB = maToZ(p.end);
      const zMin = Math.min(zA, zB);
      const zMax = Math.max(zA, zB);
      const segLen = Math.max(1, zMax - zMin);
      const zCenter = (zMin + zMax) / 2;

      const seg = new THREE.Mesh(
        new THREE.BoxGeometry(SLAB_W + 0.6, segH, segLen),
        new THREE.MeshStandardMaterial({ color: p.color, roughness: 0.65, metalness: 0.05 })
      );
      seg.position.set(0, topY, zCenter);
      slabGroup.add(seg);

      // Boundary lines (thin black dividers)
      const divider = new THREE.Mesh(
        new THREE.BoxGeometry(SLAB_W + 1.2, segH + 0.01, 0.8),
        new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 1.0, metalness: 0.0 })
      );
      divider.position.set(0, topY + 0.01, zMax);
      slabGroup.add(divider);

      // Label at segment center
      const labelDiv = document.createElement("div");
      labelDiv.className = "label";
      labelDiv.textContent = p.name;
      const labelObj = new CSS2DObject(labelDiv);
      labelObj.position.set(0, topY + 6.0, zCenter);
      slabGroup.add(labelObj);

      periodSegments.push({ ...p, zMin, zMax, zCenter });
    }

    // End markers (older/present)
    function makeEndLabel(text, z) {
      const div = document.createElement("div");
      div.className = "label";
      div.textContent = text;
      const obj = new CSS2DObject(div);
      obj.position.set(0, topY + 14, z);
      slabGroup.add(obj);
    }
    makeEndLabel("541 Ma (Cambrian start)", -SLAB_LEN / 2);
    makeEndLabel("0 Ma (Present)", SLAB_LEN / 2);

    // -----------------------
    // Person (player)
    // -----------------------
    const player = new THREE.Group();
    scene.add(player);

    const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.55, metalness: 0.05 });
    const accentMat = new THREE.MeshStandardMaterial({ color: 0x9aa0a6, roughness: 0.7, metalness: 0.0 });

    // Simple humanoid: capsule-ish body + head
    const body = new THREE.Mesh(new THREE.CapsuleGeometry(4.2, 10, 8, 16), bodyMat);
    body.position.y = 10;
    const head = new THREE.Mesh(new THREE.SphereGeometry(3.2, 20, 20), bodyMat);
    head.position.y = 18.2;

    const feet = new THREE.Mesh(new THREE.BoxGeometry(6.8, 1.6, 6.8), accentMat);
    feet.position.y = 3.2;

    player.add(body, head, feet);

    // Position player on slab top
    const playerYStanding = topY + segH / 2 + 9.0;
    player.position.set(0, playerYStanding, maToZ(250)); // start near Mesozoic-ish
    player.rotation.y = Math.PI; // face toward older end visually

    // -----------------------
    // Game state
    // -----------------------
    const keys = { ArrowUp: false, ArrowDown: false };
    let score = 0;

    let currentPromptMa = null;
    let currentPromptPeriod = null;
    let sitLock = false;

    function getPeriodForMa(ma) {
      for (const p of PERIODS) {
        // inclusive older boundary, exclusive younger boundary (except end=0)
        if (ma <= p.start && (ma > p.end || (p.end === 0 && ma >= 0))) return p;
      }
      return null;
    }

    function getPeriodForZ(z) {
      for (const seg of periodSegments) {
        if (z >= seg.zMin && z < seg.zMax) return seg;
      }
      // edge case at the absolute end
      if (z >= periodSegments[periodSegments.length - 1].zMin) return periodSegments[periodSegments.length - 1];
      if (z < periodSegments[0].zMax) return periodSegments[0];
      return null;
    }

    function newPrompt() {
      // Random Ma in [0.1, 540.9], one decimal place
      const ma = +(0.1 + Math.random() * (540.8)).toFixed(1);
      const period = getPeriodForMa(ma);
      currentPromptMa = ma;
      currentPromptPeriod = period;

      const periodName = period ? period.name : "Unknown";
      promptMain.textContent = `Sit at: ${ma} million years ago (Ma)`;
      // If you want to show the target period (easy mode), uncomment:
      // promptMain.textContent = `Sit at: ${ma} Ma — (${periodName})`;
    }

    function setScore(v) {
      score = v;
      scoreEl.textContent = `Score: ${score}`;
    }

    function flash(colorClass) {
      flashEl.classList.remove("green", "red", "on");
      flashEl.classList.add(colorClass, "on");
      window.setTimeout(() => flashEl.classList.remove("on"), 180);
      window.setTimeout(() => flashEl.classList.remove(colorClass), 520);
    }

    function setSitting(isSitting) {
      if (isSitting) {
        // squat/sit approximation
        player.position.y = playerYStanding - 6.5;
        body.scale.set(1, 0.75, 1);
        head.position.y = 16.2;
        feet.position.y = 2.8;
      } else {
        player.position.y = playerYStanding;
        body.scale.set(1, 1, 1);
        head.position.y = 18.2;
        feet.position.y = 3.2;
      }
    }

    function evaluateSit() {
      const playerPeriod = getPeriodForZ(player.position.z);
      const ok = playerPeriod && currentPromptPeriod && (playerPeriod.name === currentPromptPeriod.name);

      if (ok) {
        flash("green");
        setScore(score + 1);
      } else {
        flash("red");
        setScore(score - 1);
      }

      newPrompt();
    }

    // -----------------------
    // Input handling
    // -----------------------
    window.addEventListener("keydown", (e) => {
      if (e.code === "ArrowUp" || e.code === "ArrowDown" || e.code === "Space") e.preventDefault();

      if (e.code === "ArrowUp") keys.ArrowUp = true;
      if (e.code === "ArrowDown") keys.ArrowDown = true;

      if (e.code === "Space" && !sitLock) {
        sitLock = true;
        setSitting(true);
        evaluateSit();

        window.setTimeout(() => {
          setSitting(false);
          sitLock = false;
        }, 350);
      }
    }, { passive: false });

    window.addEventListener("keyup", (e) => {
      if (e.code === "ArrowUp") keys.ArrowUp = false;
      if (e.code === "ArrowDown") keys.ArrowDown = false;
    });

    // -----------------------
    // Animation loop
    // -----------------------
    const clock = new THREE.Clock();
    const speed = 140; // units per second along slab

    function animate() {
      requestAnimationFrame(animate);
      const dt = Math.min(0.033, clock.getDelta());

      // Movement (↑ toward present/younger; ↓ toward older)
      if (!sitLock) {
        let dz = 0;
        if (keys.ArrowUp) dz += speed * dt;
        if (keys.ArrowDown) dz -= speed * dt;
        player.position.z = THREE.MathUtils.clamp(player.position.z + dz, -SLAB_LEN / 2 + 6, SLAB_LEN / 2 - 6);
      }

      // Camera follow (keeps player centered while still allowing orbit controls)
      controls.target.set(0, 0, player.position.z);
      controls.update();

      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }

    // -----------------------
    // Resize
    // -----------------------
    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      labelRenderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener("resize", onResize);

    // Start
    setScore(0);
    newPrompt();
    animate();
  </script>
</body>
</html>
